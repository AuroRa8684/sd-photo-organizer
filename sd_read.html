<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>照片智能整理与 AI 分析助手</title>

    <style>
      :root{
        --blue:#4A6AFF;
        --bg:#F4F6FA;
        --card:#FFFFFF;
        --text:#1B1F2A;
        --sub:#5A6170;
        --border:#DDE2EC;
        --success:#3CC480;
        --danger:#FF6B6B;
        --accent:#FFB347;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;
        background:radial-gradient(circle at top left,#F7FAFF 0,#F4F6FA 40%,#EEF1F8 100%);
        color:var(--text);
        font-family: Inter,"PingFang SC","Microsoft Yahei",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      }

      .app{min-height:100vh; display:flex; flex-direction:column;}

      /* 顶部导航 */
      .topbar{
        height:72px;
        padding:0 24px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        background:linear-gradient(90deg,rgba(74,106,255,0.06),rgba(255,255,255,0.95));
        border-bottom:1px solid var(--border);
        backdrop-filter:blur(12px);
      }
      .brand{display:flex; align-items:center; gap:12px;}
      .logo{
        width:36px;height:36px;border-radius:14px;
        background:conic-gradient(from 180deg at 50% 50%,#4A6AFF,#7AB2FF,#9CD3FF,#4A6AFF);
        box-shadow:0 10px 30px rgba(74,106,255,.35);
      }
      .title{font-weight:700; letter-spacing:.2px;}
      .subtitle{font-size:12px;color:var(--sub);margin-top:2px;}

      .top-actions{display:flex; align-items:center; gap:12px;}
      .btn{
        border:1px solid var(--border);
        background:var(--card);
        color:var(--text);
        padding:8px 14px;
        border-radius:999px;
        cursor:pointer;
        transition:.15s;
        display:inline-flex; align-items:center; gap:8px;
        font-size:13px;
      }
      .btn:hover{filter:brightness(1.04); box-shadow:0 4px 12px rgba(15,23,42,.08);}
      .btn.primary{background:var(--blue); border-color:var(--blue); color:#fff;}
      .btn.ghost{background:#F7F9FC;}
      .btn.tiny{padding:4px 10px; font-size:12px;}
      .btn.chip{
        background:rgba(255,255,255,0.5);
        border-style:dashed;
      }
      .btn.disabled{
        opacity:0.5;
        cursor:not-allowed;
        box-shadow:none;
        filter:none;
      }

      .dot{width:8px;height:8px;border-radius:50%;}
      .dot.on{background:var(--success);}
      .dot.off{background:#C9CEDA;}

      /* toggle */
      .toggle{display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none;}
      .toggle input{display:none;}
      .slider{
        width:42px;height:22px;border-radius:999px;background:#CFD5E2; position:relative; transition:.2s;
      }
      .slider::after{
        content:""; width:18px;height:18px;border-radius:50%;
        background:#fff; position:absolute; top:2px; left:2px; transition:.2s;
        box-shadow:0 2px 6px rgba(0,0,0,.12);
      }
      .toggle input:checked + .slider{background:var(--blue);}
      .toggle input:checked + .slider::after{left:22px;}
      .toggle .label{font-size:14px; color:var(--sub);}

      /* 主体布局 */
      .layout{
        flex:1;
        display:grid;
        grid-template-columns: 20% 60% 20%;
        gap:16px;
        padding:16px 24px 8px;
        align-items:start;
      }

      /* 左侧筛选 */
      .sidebar{
        background:var(--card);
        border:1px solid var(--border);
        border-radius:18px;
        padding:12px;
        display:flex;
        flex-direction:column;
        gap:12px;
        min-height:720px;
        overflow:hidden;
        box-shadow:0 18px 45px rgba(15,23,42,.06);
      }
      .sidebar.collapsed{
        width:64px;
        min-width:64px;
        padding:12px 8px;
      }
      .sidebar-header{display:flex; align-items:center; justify-content:space-between;}
      .icon-btn{
        border:none; background:transparent; cursor:pointer; font-size:18px; color:var(--sub);
        width:34px;height:34px;border-radius:10px;
      }
      .icon-btn:hover{background:#F4F6FA}
      .panel{
        border:1px solid var(--border);
        border-radius:14px;
        padding:10px;
        background:radial-gradient(circle at top left,#F9FAFF,#FAFBFF);
      }
      .panel-title{font-weight:700; margin-bottom:8px; font-size:13px; display:flex;align-items:center;gap:6px;}
      .panel-title span.badge-mini{
        padding:2px 6px; border-radius:999px; background:#EEF2FF; color:var(--blue); font-size:11px;
      }
      .tag-group{display:flex; gap:8px; flex-wrap:wrap;}
      .tag{
        padding:5px 10px;
        border-radius:999px;
        border:1px solid var(--border);
        background:#fff;
        cursor:pointer;
        font-size:12px;
      }
      .tag.active{background:var(--blue); border-color:var(--blue); color:#fff;}
      .select-row{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px;}
      .select-row label{font-size:12px; color:var(--sub); min-width:40px;}
      select{
        width:100%;
        padding:7px 10px;
        border-radius:999px;
        border:1px solid var(--border);
        background:#fff;
        color:var(--text);
        font-size:13px;
      }
      .chips{display:flex; gap:8px; flex-wrap:wrap;}
      .chip{
        background:#E9EDFF; color:var(--blue);
        padding:4px 10px;
        border-radius:999px;
        cursor:pointer;
        font-size:12px;
      }

      /* 中间照片墙 */
      .gallery{
        background:var(--card);
        border:1px solid var(--border);
        border-radius:18px;
        padding:12px;
        min-height:720px;
        display:flex;
        flex-direction:column;
        box-shadow:0 18px 45px rgba(15,23,42,.05);
      }
      .gallery-header{
        display:flex; align-items:center; justify-content:space-between;
        margin-bottom:12px;
      }
      .gallery-header .left{
        display:flex; flex-direction:column; gap:2px;
      }
      .gallery-header .title-main{font-weight:700;}
      .gallery-header .subtitle-main{font-size:12px;color:var(--sub);}
      .sort{display:flex; align-items:center; gap:8px; color:var(--sub); font-size:13px;}
      .masonry{
        column-count:3;
        column-gap:12px;
      }
      .photo-card{
        break-inside:avoid;
        border-radius:14px;
        overflow:hidden;
        border:1px solid rgba(199,209,235,0.9);
        background:radial-gradient(circle at top,#F5F7FF,#F7F9FC);
        margin-bottom:12px;
        position:relative;
      }
      .photo{
        height:170px;
        background:linear-gradient(135deg,#EEF2FF,#F8F9FF);
        position:relative;
        cursor:pointer;
      }
      .badge{
        position:absolute;
        bottom:8px;
        padding:4px 8px;
        border-radius:999px;
        font-size:11px;
        color:#fff;
        background:rgba(0,0,0,.55);
      }
      .badge.format{left:8px;}
      .badge.date{right:8px;}
      .badge.ai{
        top:8px; right:8px; bottom:auto;
        background:rgba(74,106,255,.85);
        display:flex;align-items:center;gap:4px;
      }
      .badge.ai span.dot-mini{
        width:6px;height:6px;border-radius:50%;background:#A5B4FC;
      }
      .hover-info{
        padding:10px;
        background:#fff;
        color:var(--sub);
        font-size:13px;
        line-height:1.35;
      }
      .hover-info .name-line{
        display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;
      }
      .pill-soft{
        padding:2px 7px;border-radius:999px;
        font-size:11px;
        background:#F2F4FF;
        color:var(--blue);
      }
      .load-more{margin-top:12px; text-align:center;}

      .empty-tip{
        flex:1;
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        color:var(--sub);
        font-size:13px;
        text-align:center;
        gap:8px;
      }
      .empty-circle{
        width:72px;height:72px;border-radius:50%;
        background:radial-gradient(circle at top,#EEF2FF,#FFFFFF);
        border:1px dashed #CBD5F5;
        display:grid;place-items:center;
        color:var(--blue);
        font-size:24px;
      }

      /* 右侧看板 */
      .right-panel{
        position:sticky;
        top:16px;
        display:flex;
        flex-direction:column;
        gap:12px;
      }
      .right-panel .panel{box-shadow:0 14px 30px rgba(15,23,42,.04);}

      .progress-item{margin-bottom:10px;}
      .progress-top{display:flex; justify-content:space-between; color:var(--sub); font-size:12px;}
      .bar{
        width:100%; height:8px; background:#EEF1F7;
        border-radius:999px; overflow:hidden; margin-top:6px;
      }
      .bar-fill{height:100%; width:0%; background:var(--blue); transition:width .3s;}
      .bar-fill.success{background:var(--success);}
      .bar-fill.error{background:var(--danger);}

      .stats{
        display:grid;
        grid-template-columns:repeat(2, 1fr);
        gap:8px;
      }
      .stat{
        padding:10px;
        border-radius:12px;
        background:#F7F9FC;
        border:1px solid #EFF2F8;
      }
      .stat-label{font-size:12px;color:var(--sub);}
      .stat-value{font-size:18px;font-weight:800;margin-top:4px;}

      /* AI 分析区 + 美化模块 */
      .ai-block{
        margin:8px 24px 96px;
        padding:16px 18px 18px;
        background:var(--card);
        border:1px solid var(--border);
        border-radius:18px;
        box-shadow:0 18px 45px rgba(15,23,42,.05);
      }
      .ai-header{display:flex; align-items:center; justify-content:space-between; gap:12px;}
      .ai-title-wrap{display:flex;flex-direction:column;gap:2px;}
      .ai-title{font-size:18px;font-weight:800;}
      .ai-sub{font-size:12px;color:var(--sub);}
      .ai-text{color:var(--sub); line-height:1.7; margin:10px 0 16px;}
      .charts{
        display:grid;
        grid-template-columns:repeat(3, 1fr);
        gap:12px;
      }
      .chart-card{
        background:#FAFBFF;
        border:1px solid var(--border);
        border-radius:14px;
        padding:12px;
      }
      .chart-title{font-weight:700;margin-bottom:8px;font-size:13px;}
      .chart-placeholder{
        height:200px;
        border-radius:10px;
        background:linear-gradient(135deg,#EEF2FF,#F8F9FF);
        display:grid;
        place-items:center;
        color:var(--sub);
        border:1px dashed #DCE3F6;
        font-size:12px;
      }

      /* AI 图片美化模块 */
      .ai-enhance{
        margin-top:18px;
        padding:14px;
        border-radius:16px;
        background:linear-gradient(135deg,rgba(74,106,255,0.06),rgba(255,255,255,0.96));
        border:1px solid #D5DDF6;
      }
      .ai-enhance.disabled{
        opacity:0.65;
        background:radial-gradient(circle at top,#F3F4F6,#FFFFFF);
      }
      .ai-enhance-header{
        display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;
      }
      .ai-enhance-title{
        display:flex;align-items:center;gap:8px;
        font-weight:700;font-size:14px;
      }
      .tag-soft{
        padding:2px 8px;border-radius:999px;
        background:#FEF3C7;color:#92400E;
        font-size:11px;
      }
      .ai-enhance-desc{font-size:12px;color:var(--sub);}
      .ai-enhance-body{
        margin-top:10px;
        display:grid;
        grid-template-columns: 40% 60%;
        gap:12px;
      }
      .ai-preview{
        border-radius:14px;
        border:1px solid #CBD5FF;
        background:radial-gradient(circle at top,#EEF2FF,#FFFFFF);
        min-height:210px;
        padding:10px;
        display:flex;flex-direction:column;
      }
      .ai-preview-header{
        display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;font-size:12px;color:var(--sub);
      }
      .ai-preview-main{
        flex:1;
        border-radius:10px;
        background:repeating-linear-gradient(135deg,#E5E7EB,#E5E7EB 6px,#F9FAFB 6px,#F9FAFB 12px);
        display:grid;place-items:center;
        color:var(--sub);
        font-size:12px;
        position:relative;
        overflow:hidden;
      }
      .ai-preview-main::after{
        content:"AI 美化预览";
        position:absolute;
        top:10px;left:10px;
        padding:2px 8px;
        border-radius:999px;
        font-size:11px;
        background:rgba(0,0,0,.56);
        color:#fff;
      }
      .ai-preview.empty .ai-preview-main{
        background:radial-gradient(circle at top,#F1F5F9,#F9FAFB);
      }
      .ai-preview-meta{
        margin-top:6px;
        font-size:11px;
        color:var(--sub);
        display:flex;
        justify-content:space-between;
      }

      .ai-controls{
        border-radius:14px;
        border:1px solid #E0E7FF;
        background:rgba(248,250,252,0.9);
        padding:10px 12px;
        display:flex;
        flex-direction:column;
        gap:8px;
        font-size:12px;
      }
      .pill-tabs{
        display:inline-flex;
        background:#E5E7EB;
        border-radius:999px;
        padding:2px;
        gap:2px;
      }
      .pill-tabs button{
        border:none;
        background:transparent;
        border-radius:999px;
        padding:4px 10px;
        font-size:12px;
        cursor:pointer;
        color:var(--sub);
      }
      .pill-tabs button.active{
        background:#FFFFFF;
        color:var(--blue);
        box-shadow:0 1px 4px rgba(15,23,42,.12);
      }
      .form-row{
        display:flex;align-items:center;justify-content:space-between;gap:8px;
      }
      .form-row label{white-space:nowrap;color:var(--sub);}
      .form-row select{
        flex:1;
        padding:6px 8px;
        border-radius:999px;
        border:1px solid var(--border);
        background:#fff;
      }
      .form-row input[type=range]{
        flex:1;
      }
      .ai-controls-bottom{
        display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;
      }
      .status-text{font-size:12px;color:var(--sub);}
      .status-dot{
        width:8px;height:8px;border-radius:50%;margin-right:4px;display:inline-block;
        background:#CBD5E1;
      }
      .status-processing{background:var(--blue);}
      .status-done{background:var(--success);}
      .status-idle{background:#CBD5E1;}

      .queue-list{
        margin-top:4px;
        max-height:80px;
        overflow:auto;
        border-top:1px dashed #CBD5E1;
        padding-top:4px;
      }
      .queue-item{
        display:flex;justify-content:space-between;align-items:center;
        font-size:11px;color:var(--sub);
        margin-bottom:2px;
      }

      /* 底部操作栏 */
      .footer-bar{
        position:fixed;
        left:0; right:0; bottom:0;
        height:72px;
        display:flex; align-items:center; justify-content:center;
        background:rgba(255,255,255,.96);
        border-top:1px solid var(--border);
        backdrop-filter: blur(8px);
      }
      .footer-actions{display:flex; gap:12px; flex-wrap:wrap; justify-content:center;}

      /* 预览弹窗（空壳） */
      .modal-mask{
        position:fixed; inset:0;
        background:rgba(0,0,0,.35);
        display:flex; align-items:center; justify-content:center;
        padding:24px;
      }
      .modal{
        width:min(980px, 92vw);
        height:min(620px, 80vh);
        background:var(--card);
        border-radius:16px;
        border:1px solid var(--border);
        overflow:hidden;
        display:flex; flex-direction:column;
        box-shadow:0 24px 60px rgba(15,23,42,.35);
      }
      .modal-head{
        height:56px;
        display:flex; align-items:center; justify-content:space-between;
        padding:0 14px;
        border-bottom:1px solid var(--border);
      }
      .modal-body{
        flex:1;
        display:grid;
        place-items:center;
        background:radial-gradient(circle at top,#EEF2FF,#FFFFFF);
        color:var(--sub);
      }

      /* 小屏适配 */
      @media (max-width: 1400px){
        .masonry{column-count:2;}
        .charts{grid-template-columns:1fr;}
        .ai-enhance-body{grid-template-columns:1fr;}
      }
    </style>
  </head>

  <body>
    <div id="app"></div>

    <!-- Vue 3：全局构建（不使用 import） -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <script>
      const { createApp, ref, reactive, computed, onMounted, watch, nextTick } = Vue;

      // 后端API地址
      const API_BASE = "http://127.0.0.1:8000";

      // API 封装
      const api = {
        async get(url) {
          const res = await fetch(API_BASE + url);
          return res.json();
        },
        async post(url, data) {
          const res = await fetch(API_BASE + url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          return res.json();
        },
        async patch(url, data) {
          const res = await fetch(API_BASE + url, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          return res.json();
        },
        async delete(url, data) {
          const res = await fetch(API_BASE + url, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: data ? JSON.stringify(data) : undefined,
          });
          return res.json();
        },
      };

      createApp({
        setup() {
          const sdConnected = ref(false);
          const syncOn = ref(true);
          const collapsed = ref(false);
          const sortOrder = ref("desc");
          const previewOpen = ref(false);

          // SD卡路径
          const sdPath = ref("");
          const libraryPath = ref("D:\\Photos");
          const showPathInput = ref(false);
          const scanning = ref(false);
          const classifying = ref(false);
          const currentPage = ref(1);
          const totalPhotos = ref(0);

          // 是否已完成导入“导入照片”（控制 AI 美化模块启用）
          const photosImported = ref(false);

          // AI 美化相关
          const enhanceMode = ref("single"); // single | batch
          const selectedPhoto = ref(null);
          const enhanceStrength = ref(70);
          const enhanceStyle = ref("natural");
          const enhanceStatus = ref("idle"); // idle | processing | done
          const enhanceQueue = ref([]);

          const fileTypes = [
            { label: "全部", value: "all" },
            { label: "JPG 格式", value: "jpg" },
            { label: "RAW 格式", value: "raw" }
          ];
          const years = ["2024", "2025"];
          const months = ["01", "02", "03", "04"];
          const days = ["01", "02", "03", "04", "05"];
          const periods = ["上午", "下午", "晚上", "凌晨"];
          const statuses = [
            { label: "已同步照片", value: "synced" },
            { label: "未同步照片", value: "unsynced" },
            { label: "待分类照片", value: "uncategorized" }
          ];

          const filters = reactive({
            types: ["all"],
            year: "",
            month: "",
            day: "",
            period: "",
            status: []
          });

          // 初始不加载照片，必须“导入”后才有
          const photos = ref([]);

          const progress = reactive({ read: 0, classify: 0, sync: 0 });
          const pStatus = reactive({ read: "active", classify: "active", sync: "active" });

          const stats = computed(() => {
            const total = photos.value.length;
            const jpg = photos.value.filter(p => p.format === "JPG").length;
            const raw = photos.value.filter(p => p.format === "RAW").length;
            const uncategorized = photosImported.value ? 2 : 0; // 占位
            const synced = photos.value.filter(p => p.status === "synced").length;
            return [
              { label: "总照片数", value: total },
              { label: "JPG 数量", value: jpg },
              { label: "RAW 数量", value: raw },
              { label: "未分类数量", value: uncategorized },
              { label: "同步完成数", value: synced }
            ];
          });

          const aiSummary = ref(
            "（空壳示例）当你从 SD 卡导入照片后，将在这里看到基于拍摄数量、时间跨度、格式占比和高频时段的智能拍摄总结。"
          );

          const selectedTags = computed(() => {
            const t = [];
            filters.types.forEach(v => v !== "all" && t.push(v.toUpperCase()));
            filters.year && t.push(filters.year + "年");
            filters.month && t.push(filters.month + "月");
            filters.day && t.push(filters.day + "日");
            filters.period && t.push(filters.period);
            filters.status.forEach(s => t.push(s));
            return t;
          });

          const filteredPhotos = computed(() => {
            let list = photos.value.slice();

            if (!filters.types.includes("all")) {
              const allowed = new Set(filters.types.map(x => x.toLowerCase()));
              list = list.filter(p => allowed.has(p.format.toLowerCase()));
            }
            if (filters.period) list = list.filter(p => p.period === filters.period);
            if (filters.status.length) {
              const s = new Set(filters.status);
              list = list.filter(p => s.has(p.status));
            }

            list.sort((a, b) => (sortOrder.value === "desc" ? b.id - a.id : a.id - b.id));
            return list;
          });

          const hasPhotos = computed(() => filteredPhotos.value.length > 0);
          const canUseEnhance = computed(() => photosImported.value && hasPhotos.value);

          function toggleType(val) {
            if (val === "all") {
              filters.types = ["all"];
              return;
            }
            const set = new Set(filters.types.filter(t => t !== "all"));
            set.has(val) ? set.delete(val) : set.add(val);
            filters.types = set.size ? Array.from(set) : ["all"];
          }

          function toggleStatus(val) {
            const set = new Set(filters.status);
            set.has(val) ? set.delete(val) : set.add(val);
            filters.status = Array.from(set);
          }

          function removeTag(tag) {
            const lower = tag.toLowerCase().replace(" 格式", "").replace("jpg", "jpg").replace("raw", "raw");

            if (tag === "JPG" || tag === "RAW" || tag === "JPG 格式" || tag === "RAW 格式") {
              filters.types = filters.types.filter(t => t !== lower);
              if (!filters.types.length) filters.types = ["all"];
              return;
            }
            if (tag.endsWith("年")) filters.year = "";
            if (tag.endsWith("月")) filters.month = "";
            if (tag.endsWith("日")) filters.day = "";
            if (periods.includes(tag)) filters.period = "";
            if (filters.status.includes(tag)) filters.status = filters.status.filter(s => s !== tag);
          }

          function clearFilters() {
            filters.types = ["all"];
            filters.year = "";
            filters.month = "";
            filters.day = "";
            filters.period = "";
            filters.status = [];
          }

          function mockImportPhotos() {
            // 改为使用真实API
          }

          // 从后端加载照片
          async function loadPhotosFromAPI() {
            try {
              const res = await api.get(`/photos?page=${currentPage.value}&page_size=50`);
              if (res.data && res.data.photos) {
                photos.value = res.data.photos.map(p => ({
                  id: p.id,
                  name: p.file_name,
                  format: p.has_raw ? "RAW" : "JPG",
                  date: p.taken_at ? p.taken_at.split("T")[0] : "未知",
                  time: p.taken_at ? formatTime(p.taken_at) : "",
                  resolution: `${p.width || 0}x${p.height || 0}`,
                  size: formatFileSize(p.file_size),
                  status: p.library_path ? "synced" : "unsynced",
                  period: getTimePeriod(p.taken_at),
                  category: p.category || "未分类",
                  thumb_url: p.thumb_url,
                  is_selected: p.is_selected,
                  camera_model: p.camera_model,
                  lens: p.lens,
                  focal_length: p.focal_length,
                  aperture: p.aperture,
                  shutter: p.shutter,
                  iso: p.iso,
                }));
                totalPhotos.value = res.data.total;
                photosImported.value = photos.value.length > 0;
                if (!selectedPhoto.value && photos.value.length) {
                  selectedPhoto.value = photos.value[0];
                }
              }
            } catch (e) {
              console.error("加载照片失败:", e);
            }
          }

          function formatTime(dateStr) {
            if (!dateStr) return "";
            const d = new Date(dateStr);
            const h = d.getHours();
            const m = d.getMinutes();
            const period = h < 6 ? "凌晨" : h < 12 ? "上午" : h < 18 ? "下午" : "晚上";
            return `${period} ${h}:${String(m).padStart(2, "0")}`;
          }

          function formatFileSize(bytes) {
            if (!bytes) return "未知";
            if (bytes < 1024) return bytes + "B";
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + "KB";
            return (bytes / 1024 / 1024).toFixed(1) + "MB";
          }

          function getTimePeriod(dateStr) {
            if (!dateStr) return "未知";
            const h = new Date(dateStr).getHours();
            return h < 6 ? "凌晨" : h < 12 ? "上午" : h < 18 ? "下午" : "晚上";
          }

          function getThumbUrl(photo) {
            if (!photo.thumb_url) return "";
            return API_BASE + photo.thumb_url;
          }

          async function scanSdCard() {
            if (!sdPath.value) {
              alert("请输入SD卡路径");
              showPathInput.value = true;
              return;
            }
            scanning.value = true;
            progress.read = 10;
            pStatus.read = "active";
            try {
              const res = await api.post("/photos/scan", { sd_path: sdPath.value });
              progress.read = 100;
              pStatus.read = "success";
              if (res.error) {
                alert("扫描失败: " + res.message);
                return;
              }
              sdConnected.value = true;
              photosImported.value = true;
              await loadPhotosFromAPI();
              await loadSummary();
            } catch (e) {
              progress.read = 0;
              pStatus.read = "error";
              alert("扫描失败: " + e.message);
            } finally {
              scanning.value = false;
            }
          }

          async function classifyAllPhotos() {
            if (photos.value.length === 0) {
              alert("请先导入照片");
              return;
            }
            classifying.value = true;
            progress.classify = 10;
            pStatus.classify = "active";
            try {
              const photoIds = photos.value.map(p => p.id);
              const res = await api.post("/ai/classify", { 
                photo_ids: photoIds,
                max_workers: 4,
                skip_classified: true
              });
              progress.classify = 100;
              pStatus.classify = "success";
              await loadPhotosFromAPI();
              alert(res.message || "分类完成");
            } catch (e) {
              progress.classify = 0;
              pStatus.classify = "error";
              alert("分类失败: " + e.message);
            } finally {
              classifying.value = false;
            }
          }

          async function loadSummary() {
            try {
              const res = await api.post("/summary/generate", { save_history: true });
              if (res.data && res.data.ai_summary) {
                aiSummary.value = res.data.ai_summary;
              }
            } catch (e) {
              console.error("生成总结失败:", e);
            }
          }

          function connectSdCard() {
            if (sdConnected.value) {
              sdConnected.value = false;
              photos.value = [];
              photosImported.value = false;
              selectedPhoto.value = null;
              progress.read = 0;
              progress.classify = 0;
              progress.sync = 0;
              return;
            }
            if (!sdPath.value) {
              showPathInput.value = true;
            } else {
              scanSdCard();
            }
          }

          function preview(p) {
            if (p) selectedPhoto.value = p;
            previewOpen.value = true;
          }

          async function loadMore() {
            if (!photosImported.value) {
              alert("请先导入照片");
              return;
            }
            currentPage.value++;
            await loadPhotosFromAPI();
          }

          // AI 美化交互
          function triggerEnhance() {
            if (!canUseEnhance.value) { alert("请先导入照片"); return; }
            enhanceStatus.value = "processing";
            setTimeout(() => { enhanceStatus.value = "done"; }, 800);
          }

          function enqueueBatch() {
            if (!filteredPhotos.value.length) { alert("没有照片"); return; }

            const step = () => {
              progress.read = Math.min(100, progress.read + 10);
              progress.classify = Math.min(100, progress.classify + 8);
              progress.sync = syncOn.value ? Math.min(100, progress.sync + 9) : progress.sync;

              if (progress.read >= 100) pStatus.read = "success";
              if (progress.classify >= 100) pStatus.classify = "success";
              if (syncOn.value && progress.sync >= 100) pStatus.sync = "success";

              // 读取进度到一半时，模拟“照片已导入”
              if (progress.read >= 50 && !photosImported.value) {
                mockImportPhotos();
              }

              if (progress.read < 100 || progress.classify < 100 || (syncOn.value && progress.sync < 100)) {
                setTimeout(step, 120);
              }
            };
            step();
          }

          function preview(p) {
            if (p) selectedPhoto.value = p;
            previewOpen.value = true;
          }

          function loadMore() {
            if (!photosImported.value) {
              alert("请先从 SD 卡导入照片，再加载更多（空壳提示）");
              return;
            }
            const start = photos.value.length + 1;
            const more = Array.from({ length: 6 }).map((_, i) => ({
              id: start + i,
              name: `IMG_${String(start + i).padStart(4, "0")}.JPG`,
              format: (start + i) % 3 === 0 ? "RAW" : "JPG",
              date: "2025-01-12",
              time: ["上午 10:12", "下午 15:08", "晚上 19:21"][i % 3],
              resolution: ["6000x4000", "8256x5504"][i % 2],
              size: ["12.4MB", "28.1MB"][i % 2],
              status: (start + i) % 2 === 0 ? "synced" : "unsynced",
              period: ["上午", "下午", "晚上", "凌晨"][i % 4]
            }));
            photos.value = photos.value.concat(more);
          }

          // AI 美化交互（空壳逻辑）
          function triggerEnhance() {
            if (!canUseEnhance.value) {
              alert("请先从 SD 卡导入照片，并至少有一张可用照片，再进行 AI 美化（空壳提示）");
              return;
            }
            if (!selectedPhoto.value) {
              alert("请先在照片墙中选择一张照片作为美化对象（空壳提示）");
              return;
            }
            enhanceStatus.value = "processing";
            setTimeout(() => {
              enhanceStatus.value = "done";
            }, 800);
          }

          function enqueueBatch() {
            if (!canUseEnhance.value) {
              alert("请先完成照片导入，再使用批量美化（空壳提示）");
              return;
            }
            if (!filteredPhotos.value.length) {
              alert("当前没有可批量美化的照片（空壳提示）");
              return;
            }
            enhanceQueue.value = filteredPhotos.value.slice(0, 6).map(p => ({
              id: p.id,
              name: p.name,
              status: "排队中"
            }));
          }

          function openSettings(){ alert("设置（空壳）"); }
          function exportAISummary(){ alert("导出 AI 总结（空壳）"); }
          function exportReport(){ alert("导出 AI 总结报告（空壳）"); }
          function exportClassified(){ alert("导出分类照片（空壳）"); }
          function reRead(){ alert("重新读取 SD 卡（空壳）"); }
          function reClassify(){ alert("重新分类整理（空壳）"); }
          function syncLocal(){ alert("一键同步本地图库（空壳）"); }
          function clearCache(){ alert("清空缓存（空壳）"); }

          function copySummary(){
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(aiSummary.value);
              alert("已复制（空壳）");
            } else {
              alert("浏览器不支持剪贴板 API（空壳）");
            }
          }

          // 页面加载时自动加载已有照片
          onMounted(async () => {
            try {
              await loadPhotosFromAPI();
              if (photos.value.length > 0) {
                sdConnected.value = true;
                progress.read = 100;
                pStatus.read = "success";
              }
            } catch (e) {
              console.log("初始加载:", e);
            }
          });

          return {
            sdConnected, syncOn, collapsed, sortOrder, previewOpen,
            photosImported,
            sdPath, libraryPath, showPathInput, scanning, classifying, currentPage, totalPhotos,
            enhanceMode, selectedPhoto, enhanceStrength, enhanceStyle, enhanceStatus, enhanceQueue,
            canUseEnhance,
            fileTypes, years, months, days, periods, statuses,
            filters, selectedTags, filteredPhotos, hasPhotos,
            progress, pStatus, stats, aiSummary,
            toggleType, toggleStatus, removeTag, clearFilters,
            connectSdCard, openSettings, exportAISummary,
            preview, loadMore, scanSdCard, classifyAllPhotos, loadPhotosFromAPI, getThumbUrl,
            exportReport, exportClassified, reRead, reClassify, syncLocal, clearCache, copySummary,
            triggerEnhance, enqueueBatch
          };
        },

        template: `
          <div class="app">
            <header class="topbar">
              <div class="brand">
                <div class="logo"></div>
                <div>
                  <div class="title">照片智能整理与 AI 分析助手</div>
                  <div class="subtitle">SD 卡照片导入 · 智能分类 · 数据洞察与 AI 加持</div>
                </div>
              </div>
              <div class="top-actions">
                <!-- SD卡路径输入弹窗 -->
                <div v-if="showPathInput" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                  <div style="background:#fff;padding:24px;border-radius:16px;min-width:400px;">
                    <h3 style="margin:0 0 16px;">输入SD卡路径</h3>
                    <input v-model="sdPath" placeholder="例如: E:\\DCIM 或 D:\\Photos" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px;">
                    <div style="display:flex;gap:8px;justify-content:flex-end;">
                      <button class="btn ghost" @click="showPathInput=false">取消</button>
                      <button class="btn primary" @click="showPathInput=false;scanSdCard()">开始扫描</button>
                    </div>
                  </div>
                </div>
                
                <button class="btn primary" @click="connectSdCard" :disabled="scanning">
                  <span class="dot" :class="sdConnected ? 'on' : 'off'"></span>
                  {{ scanning ? '扫描中...' : (sdConnected ? '已连接 · 重新扫描' : 'SD 卡连接 / 读取') }}
                </button>
                
                <button class="btn ghost" @click="classifyAllPhotos" :disabled="classifying || !photosImported">
                  {{ classifying ? 'AI分类中...' : 'AI 智能分类' }}
                </button>

                <label class="toggle" title="开启后模拟同步进度">
                  <input type="checkbox" v-model="syncOn" />
                  <span class="slider"></span>
                  <span class="label">本地图库同步</span>
                </label>

                <button class="btn ghost" @click="openSettings">设置</button>
                <button class="btn ghost" @click="exportAISummary">
                  AI 总结导出
                </button>
              </div>
            </header>

            <main class="layout">
              <aside class="sidebar" :class="{ collapsed }">
                <div class="sidebar-header">
                  <div v-if="!collapsed" style="font-weight:800;">筛选</div>
                  <button class="icon-btn" @click="collapsed = !collapsed">{{ collapsed ? '⟩' : '⟨' }}</button>
                </div>

                <template v-if="!collapsed">
                  <section class="panel">
                    <div class="panel-title">
                      <span>基础筛选</span>
                      <span class="badge-mini">文件类型</span>
                    </div>
                    <div class="tag-group">
                      <button
                        v-for="t in fileTypes"
                        :key="t.value"
                        class="tag"
                        :class="{ active: filters.types.includes(t.value) }"
                        @click="toggleType(t.value)"
                      >{{ t.label }}</button>
                    </div>
                  </section>

                  <section class="panel">
                    <div class="panel-title">
                      <span>时间筛选</span>
                      <span class="badge-mini">拍摄维度</span>
                    </div>
                    <div class="select-row">
                      <label>年份</label>
                      <select v-model="filters.year">
                        <option value="">全部</option>
                        <option v-for="y in years" :key="y" :value="y">{{ y }}</option>
                      </select>
                    </div>
                    <div class="select-row">
                      <label>月份</label>
                      <select v-model="filters.month">
                        <option value="">全部</option>
                        <option v-for="m in months" :key="m" :value="m">{{ m }}</option>
                      </select>
                    </div>
                    <div class="select-row">
                      <label>日期</label>
                      <select v-model="filters.day">
                        <option value="">全部</option>
                        <option v-for="d in days" :key="d" :value="d">{{ d }}</option>
                      </select>
                    </div>
                    <div class="select-row" style="margin-bottom:0;">
                      <label>时段</label>
                      <select v-model="filters.period">
                        <option value="">全部</option>
                        <option v-for="p in periods" :key="p" :value="p">{{ p }}</option>
                      </select>
                    </div>
                  </section>

                  <section class="panel">
                    <div class="panel-title">
                      <span>辅助筛选</span>
                      <span class="badge-mini">同步 / 分类状态</span>
                    </div>
                    <div class="tag-group">
                      <button
                        v-for="s in statuses"
                        :key="s.value"
                        class="tag"
                        :class="{ active: filters.status.includes(s.value) }"
                        @click="toggleStatus(s.value)"
                      >{{ s.label }}</button>
                    </div>
                  </section>

                  <section class="panel" v-if="selectedTags.length">
                    <div class="panel-title">已选条件（点击移除）</div>
                    <div class="chips">
                      <span class="chip" v-for="c in selectedTags" :key="c" @click="removeTag(c)">{{ c }} ×</span>
                    </div>
                    <div style="margin-top:10px; display:flex; justify-content:flex-end;">
                      <button class="btn tiny ghost" @click="clearFilters">清空条件</button>
                    </div>
                  </section>
                </template>
              </aside>

              <section class="gallery">
                <div class="gallery-header">
                  <div class="left">
                    <div class="title-main">照片墙</div>
                    <div class="subtitle-main">
                      {{ hasPhotos ? '按筛选条件 + 时间排序自动排布，支持 AI 美化选择' : '请先从顶部连接并读取 SD 卡，导入照片后会自动展示在照片墙' }}
                    </div>
                  </div>
                  <div class="sort">
                    <span>排序</span>
                    <select v-model="sortOrder" :disabled="!hasPhotos">
                      <option value="desc">时间倒序</option>
                      <option value="asc">时间正序</option>
                    </select>
                  </div>
                </div>

                <div v-if="hasPhotos" class="masonry">
                  <div class="photo-card" v-for="p in filteredPhotos" :key="p.id">
                    <div class="photo" @click="preview(p)" :title="p.name" :style="p.thumb_url ? { backgroundImage: 'url(' + getThumbUrl(p) + ')', backgroundSize: 'cover', backgroundPosition: 'center' } : {}">
                      <div class="badge format">{{ p.format }}</div>
                      <div class="badge date">{{ p.date }}</div>
                      <div class="badge ai" v-if="p.category && p.category !== '未分类'">
                        <span class="dot-mini"></span>
                        {{ p.category }}
                      </div>
                    </div>
                    <div class="hover-info">
                      <div class="name-line">
                        <div style="font-weight:700; color:var(--text); max-width:70%; overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                          {{ p.name }}
                        </div>
                        <span class="pill-soft">{{ p.time }}</span>
                      </div>
                      <div>{{ p.format }} · {{ p.resolution }}</div>
                      <div>{{ p.size }} · {{ p.category || '未分类' }}</div>
                    </div>
                  </div>
                </div>
                <div v-else class="empty-tip">
                  <div class="empty-circle">SD</div>
                  <div>当前暂无已导入照片。请先连接并读取 SD 卡，系统将自动完成导入与分类。</div>
                </div>

                <div class="load-more">
                  <button class="btn ghost" @click="loadMore" :class="{ disabled: !photosImported }">
                    {{ photosImported ? '加载更多照片占位' : '请先导入照片' }}
                  </button>
                </div>
              </section>

              <aside class="right-panel">
                <section class="panel">
                  <div class="panel-title">实时进度</div>

                  <div class="progress-item">
                    <div class="progress-top">
                      <span>SD 卡读取</span>
                      <span>{{ progress.read }}%</span>
                    </div>
                    <div class="bar">
                      <div class="bar-fill" :class="pStatus.read" :style="{ width: progress.read + '%' }"></div>
                    </div>
                  </div>

                  <div class="progress-item">
                    <div class="progress-top">
                      <span>照片分类整理</span>
                      <span>{{ progress.classify }}%</span>
                    </div>
                    <div class="bar">
                      <div class="bar-fill" :class="pStatus.classify" :style="{ width: progress.classify + '%' }"></div>
                    </div>
                  </div>

                  <div class="progress-item" style="margin-bottom:0;">
                    <div class="progress-top">
                      <span>本地同步</span>
                      <span>{{ progress.sync }}%</span>
                    </div>
                    <div class="bar">
                      <div class="bar-fill" :class="pStatus.sync" :style="{ width: progress.sync + '%' }"></div>
                    </div>
                  </div>
                </section>

                <section class="panel">
                  <div class="panel-title">精简数据概览</div>
                  <div class="stats">
                    <div class="stat" v-for="s in stats" :key="s.label">
                      <div class="stat-label">{{ s.label }}</div>
                      <div class="stat-value">{{ s.value }}</div>
                    </div>
                  </div>
                </section>
              </aside>
            </main>

            <section class="ai-block">
              <div class="ai-header">
                <div class="ai-title-wrap">
                  <div class="ai-title">本次拍摄智能总结</div>
                  <div class="ai-sub">
                    {{ photosImported ? '已基于导入照片生成示例总结，真实环境下可替换为后端 / 模型输出。' : '导入照片后，将在这里生成一次拍摄的智能总结概览。' }}
                  </div>
                </div>
                <div style="display:flex; gap:10px;">
                  <button class="btn chip" @click="copySummary">一键复制</button>
                  <button class="btn ghost" @click="exportAISummary">导出总结</button>
                </div>
              </div>
              <p class="ai-text">{{ aiSummary }}</p>

              <div class="charts">
                <div class="chart-card">
                  <div class="chart-title">JPG / RAW 占比</div>
                  <div class="chart-placeholder">饼图占位（待接入 Echarts/Chart.js）</div>
                </div>
                <div class="chart-card">
                  <div class="chart-title">每日拍摄照片数量分布</div>
                  <div class="chart-placeholder">柱状图占位（待接入 Echarts/Chart.js）</div>
                </div>
                <div class="chart-card">
                  <div class="chart-title">各时段拍摄照片数量趋势</div>
                  <div class="chart-placeholder">折线图占位（待接入 Echarts/Chart.js）</div>
                </div>
              </div>

              <!-- AI 图片美化模块：只有导入照片后才真正启用 -->
              <div
                class="ai-enhance"
                v-if="canUseEnhance"
              >
                <div class="ai-enhance-header">
                  <div>
                    <div class="ai-enhance-title">
                      <span>AI 图片美化模块</span>
                      <span class="tag-soft">单独模块 · 需完成照片导入</span>
                    </div>
                    <div class="ai-enhance-desc">
                      已检测到导入的照片，可选择样张进行曝光、色彩与细节增强，也可对当前筛选结果一键批量美化。
                    </div>
                  </div>
                </div>
                <div class="ai-enhance-body">
                  <div class="ai-preview" :class="{ empty: !selectedPhoto }" @click="selectedPhoto && preview(selectedPhoto)">
                    <div class="ai-preview-header">
                      <span>{{ selectedPhoto ? selectedPhoto.name : "请先在上方照片墙中点选一张照片" }}</span>
                      <span style="color:var(--blue); cursor:pointer;">{{ selectedPhoto ? "查看大图预览" : "点击任意照片以选择美化对象" }}</span>
                    </div>
                    <div class="ai-preview-main">
                      <span v-if="selectedPhoto">AI 美化预览占位（前后对比待接入）</span>
                      <span v-else>尚未选择样张。选择后，这里会展示 AI 处理前后的对比效果。</span>
                    </div>
                    <div class="ai-preview-meta">
                      <span v-if="selectedPhoto">
                        {{ selectedPhoto.format }} · {{ selectedPhoto.resolution }} · {{ selectedPhoto.size }}
                      </span>
                      <span v-else>支持 JPG / RAW，自动保留原片备份。</span>
                      <span>输出配置：{{ enhanceStyle === 'film' ? '胶片质感' : enhanceStyle === 'portrait' ? '人像优化' : '自然增强' }}</span>
                    </div>
                  </div>

                  <div class="ai-controls">
                    <div class="form-row" style="justify-content:space-between;">
                      <label>模式</label>
                      <div class="pill-tabs">
                        <button :class="{active: enhanceMode === 'single'}" @click="enhanceMode = 'single'">单张预览</button>
                        <button :class="{active: enhanceMode === 'batch'}" @click="enhanceMode = 'batch'">批量美化</button>
                      </div>
                    </div>

                    <div class="form-row">
                      <label>美化强度</label>
                      <input type="range" min="0" max="100" v-model="enhanceStrength" />
                      <span>{{ enhanceStrength }}%</span>
                    </div>

                    <div class="form-row">
                      <label>风格偏好</label>
                      <select v-model="enhanceStyle">
                        <option value="natural">自然增强（默认）</option>
                        <option value="portrait">人像肤色优化</option>
                        <option value="film">胶片质感 / 电影感</option>
                      </select>
                    </div>

                    <div class="form-row" v-if="enhanceMode === 'batch'">
                      <label>批量策略</label>
                      <select>
                        <option>按当前筛选结果批量应用</option>
                        <option>仅对未同步照片应用</option>
                        <option>仅对 RAW 照片应用</option>
                      </select>
                    </div>

                    <div class="ai-controls-bottom">
                      <div class="status-text">
                        <span
                          class="status-dot"
                          :class="{
                            'status-processing': enhanceStatus === 'processing',
                            'status-done': enhanceStatus === 'done',
                            'status-idle': enhanceStatus === 'idle'
                          }"
                        ></span>
                        <span v-if="enhanceStatus === 'idle'">待处理 · 调整参数后点击开始美化（示例逻辑）</span>
                        <span v-else-if="enhanceStatus === 'processing'">AI 正在模拟美化中…（空壳进度占位）</span>
                        <span v-else>本次美化已完成（示例状态），可继续调整重新生成。</span>
                      </div>
                      <div style="display:flex;gap:6px;flex-wrap:wrap;">
                        <button class="btn tiny ghost" @click="enqueueBatch" v-if="enhanceMode === 'batch'">加入批量队列</button>
                        <button class="btn tiny primary" @click="triggerEnhance">开始 AI 美化（空壳）</button>
                      </div>
                    </div>

                    <div class="queue-list" v-if="enhanceQueue.length">
                      <div class="queue-item" v-for="item in enhanceQueue" :key="item.id">
                        <span>{{ item.name }}</span>
                        <span>{{ item.status }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 未导入照片时，AI 美化模块显示禁用提示 -->
              <div
                class="ai-enhance disabled"
                v-else
              >
                <div class="ai-enhance-header">
                  <div>
                    <div class="ai-enhance-title">
                      <span>AI 图片美化模块</span>
                      <span class="tag-soft">需先导入照片</span>
                    </div>
                    <div class="ai-enhance-desc">
                      当前尚未完成 SD 卡照片导入。请先在顶部点击「SD 卡连接 / 读取」，等待进度完成后，系统会自动启用 AI 美化能力。
                    </div>
                  </div>
                </div>
                <div class="ai-enhance-body">
                  <div class="ai-preview empty">
                    <div class="ai-preview-header">
                      <span>尚无可用照片</span>
                      <span style="color:var(--sub);">AI 预览暂不可用</span>
                    </div>
                    <div class="ai-preview-main">
                      <span>导入完成后，这里将展示选中照片的 AI 美化预览。</span>
                    </div>
                    <div class="ai-preview-meta">
                      <span>支持 JPG / RAW 格式 · 保留原片</span>
                      <span>等待导入完成…</span>
                    </div>
                  </div>
                  <div class="ai-controls">
                    <div style="font-size:12px;color:var(--sub);">
                      你可以先设置偏好参数：当真实接入 AI 服务时，导入完成后会自动使用这些参数进行图像增强。
                    </div>
                    <div class="form-row">
                      <label>美化强度</label>
                      <input type="range" min="0" max="100" v-model="enhanceStrength" disabled />
                      <span>{{ enhanceStrength }}%</span>
                    </div>
                    <div class="form-row">
                      <label>风格偏好</label>
                      <select v-model="enhanceStyle" disabled>
                        <option value="natural">自然增强（默认）</option>
                        <option value="portrait">人像肤色优化</option>
                        <option value="film">胶片质感 / 电影感</option>
                      </select>
                    </div>
                    <div style="margin-top:6px;font-size:12px;color:var(--sub);">
                      提示：AI 美化过程会在后台进行，不阻塞你继续浏览与筛选照片。
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <footer class="footer-bar">
              <div class="footer-actions">
                <button class="btn primary" @click="reRead">重新读取 SD 卡</button>
                <button class="btn primary ghost" @click="syncLocal">一键同步本地图库</button>
                <button class="btn ghost" @click="reClassify">重新分类整理</button>
                <button class="btn ghost" @click="clearCache">清空缓存</button>
                <button class="btn ghost" @click="exportReport">导出 AI 总结报告</button>
                <button class="btn ghost" @click="exportClassified">导出分类照片</button>
              </div>
            </footer>

            <div class="modal-mask" v-if="previewOpen" @click.self="previewOpen=false">
              <div class="modal">
                <div class="modal-head">
                  <div style="font-weight:800;">照片预览（UI 空壳）</div>
                  <button class="btn ghost" @click="previewOpen=false">关闭</button>
                </div>
                <div class="modal-body">
                  高清大图预览区域（待接入真实图片与元数据 & AI 前后对比）
                </div>
              </div>
            </div>
          </div>
        `
      }).mount("#app");
    </script>
  </body>
</html>